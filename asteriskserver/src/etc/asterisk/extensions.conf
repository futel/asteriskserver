[general]
clearglobalvars=no

[globals]
TRUNK=DAHDI/G2
tishbite_extension=505
jesse_extension=510
breckenridgest_extension=515
crossclinton_extension=610
robotron_extension=615
souwester_extension=620
upright_extension=625
ypsi_extension=630
mykle_extension=640
paz_extension=645
taylor_extension=655
opensignal_extension=660
oskar_in_extension=667
oskar_extension=530
r2d2_extension=670
xnor_extension=680
detroitbusco_extension=690
hoyt_extension=695
demo_extension=700
r2d2_incoming=19149775129
twilio_oskar_incoming=+15039465227
twilio_taylor_incoming=+15039266271
twilio_opensignal_incoming=+19713512383
twilio_xnor_incoming=+15034449412
twilio_ypsi_incoming=+17345476651
twilio_mykle_incoming=+15039288465
twilio_crossclinton_incoming=+19712666851
twilio_paz_incoming=+15033600056
twilio_robotron_incoming=+15039266341
twilio_souwester_incoming=+13602282259
twilio_hoyt_incoming=+15039266188
twilio_breckenridgest_incoming=+13132469283
twilio_detroitbusco_incoming=+13133327495
twilio_jesse_incoming=+15034836584
; this number is in use, but the variable is not
;voipms_leet_incoming=5034681337
twilio_pv_incoming=999
max_iterations=10

[macro-languagees]
exten => s,1,Set(CHANNEL(language)=es)

[macro-say]
; first arg is name of statement file, rest are preferred subdirs,
; ignored if empty
exten => s,1,AGI(sound_path.agi,${ARG1},${ARG2})
same => n,Background(${agi_out})

[macro-metric]
exten => s,1,AGI(metric.agi,${ARG1})

; dial number with timeout if it passes filter
[macro-filterdial]
exten => s,1,Macro(metric,macro-filterdial)
; filter or die
same => n,AGI(filter_outgoing.agi,${ARG1})
; friction, which may or may not die
same => n,AGI(friction.agi,filterdial)
; we passed, find timeout, if any, and dial
same => n,AGI(call_timeout.agi)
same => n,Macro(dial,${ARG1},${agi_out})

; dial number given by ARG1
; with timeout given by ARG2 in dial command syntax (which can be empty)
[macro-dial]
exten => s,1,Macro(metric,macro-dial)
; wait for ratelimiter
same => n,AGI(call_ratelimit.agi)
; start trying to dial
same => n,Dial(SIP/${ARG1}@${outgoingchannel},,g${ARG2})
; we have completed the call, metric and react to the outcome
; note that we don't get here if the caller hung up first
same => n,Macro(metric,outgoing-dialstatus-${DIALSTATUS}-${outgoingchannel})
same => n,Goto(s,${DIALSTATUS})
; unsuccessful, try again
same => n(CHANUNAVAIL),NoOp
same => n(CONGESTION),NoOp
same => n,Playtones(congestion) 
same => n,Congestion
; successful, fall through
same => n(ANSWER),NoOp
same => n(NOANSWER),NoOp
same => n(BUSY),NoOp
same => n(CANCEL),NoOp
same => n,Hangup

[macro-setup-iteration]
exten => s,1,Set(context_iterator=0)

; increment iterator, hangup if iterator is too large, otherwise return
[macro-iterate-guard]
exten => s,1,Set(context_iterator=$[ ${context_iterator} + 1 ])
same => n,GotoIf($[ ${context_iterator} > ${max_iterations} ]?hangup)
same => n,MacroExit
same => n(hangup),Macro(say,goodbye)
same => n,Hangup

; extension to start incoming call
; this should be OK to reach without registration?
[default-incoming]
exten => _!,1,Macro(metric,default-incoming)
; clients registered to twilio programmable voice are reaching us by a sip
; call from twilio, route accouring to how twilio describes their authorization.
; name <authname>;...                                                     
same => n,Set(tmp=${SIP_HEADER(From)})
; <authname>;...                                                          
same => n,Set(tmp=${CUT(tmp, ,2)})
; <authname>                                                              
same => n,Set(authname=${CUT(tmp,\;,1)})
same => n,Gosub(incoming-route-by-authname,s,1)
; Callers from twilio origination:
; set caller to the number called, which is in SIP_HEADER(To).
; This might just be the extension of this context, do we need all this extraction?
same => n,Set(callto=${CUT(CUT(SIP_HEADER(To),@,1),:,2)})
same => n,Goto(incoming-route-by-callto,s,1)

; XXX is this obsolete?
[incoming-route-by-authname]
exten => s,1,NoOp
same => n,Return

[incoming-route-by-callto]
; Route to appropriate context based on call origin.
exten => s,1,NoOp
; Incoming call from twilio pv.
; This is currently used to identify a call from the demo twilio pv domain.
; XXX Behavior is confusing, Linphone registers to the domain and goes to
;     default-outgoing, YATE registers and goes here?
same => n,gotoIf($["${callto}" = "${twilio_pv_incoming}"]?challenge_shadytel_main,s,1)
; Incoming call from twilio or callcentric, addressed to number forwarded.
same => n,gotoIf($["${callto}" = "${twilio_oskar_incoming}"]?ring-oskar,s,1)
same => n,gotoIf($["${callto}" = "${r2d2_incoming}"]?ring-r2d2,s,1)
same => n,gotoIf($["${callto}" = "${twilio_taylor_incoming}"]?ring-taylor,s,1)
same => n,gotoIf($["${callto}" = "${twilio_opensignal_incoming}"]?ring-opensignal,s,1)
same => n,gotoIf($["${callto}" = "${twilio_xnor_incoming}"]?ring-xnor,s,1)
same => n,gotoIf($["${callto}" = "${twilio_ypsi_incoming}"]?ring-ypsi,s,1)
same => n,gotoIf($["${callto}" = "${twilio_crossclinton_incoming}"]?ring-crossclinton,s,1)
same => n,gotoIf($["${callto}" = "${twilio_mykle_incoming}"]?ring-mykle,s,1)
same => n,gotoIf($["${callto}" = "${twilio_paz_incoming}"]?ring-paz,s,1)
same => n,gotoIf($["${callto}" = "${twilio_robotron_incoming}"]?ring-robotron,s,1)
same => n,gotoIf($["${callto}" = "${twilio_souwester_incoming}"]?ring-souwester,s,1)
same => n,gotoIf($["${callto}" = "${twilio_hoyt_incoming}"]?ring-hoyt,s,1)
same => n,gotoIf($["${callto}" = "${twilio_breckenridgest_incoming}"]?ring-breckenridgest,s,1)
same => n,gotoIf($["${callto}" = "${twilio_detroitbusco_incoming}"]?ring-detroitbusco,s,1)
same => n,gotoIf($["${callto}" = "${twilio_jesse_incoming}"]?ring-jesse,s,1)
; Fallback, go to the incoming menu.
; In practice, incoming call from voip.ms, addressed to number forwarded, goes here
same => n,Goto(incoming-ivr,s,1)

[ring-oskar]
exten => s,1,Macro(metric,ring-oskar)
same => n,Dial(SIP/${oskar_extension}@twilio-pv-termination)
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-oskar)

[ring-r2d2]
exten => s,1,Macro(metric,ring-r2d2)
same => n,Dial(SIP/${r2d2_extension})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-r2d2)

[ring-xnor]
exten => s,1,Macro(metric,ring-xnor)
same => n,Dial(SIP/${xnor_extension})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-xnor)

[ring-breckenridgest]
exten => s,1,Macro(metric,ring-breckenridgest)
same => n,Dial(SIP/${breckenridgest_extension}@twilio-pv-termination)
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-breckenridgest)

[ring-jesse]
exten => s,1,Macro(metric,ring-jesse)
same => n,Dial(SIP/${jesse_extension}@twilio-pv-termination)
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-jesse)

[ring-detroitbusco]
exten => s,1,Macro(metric,ring-detroitbusco)
same => n,Dial(SIP/${detroitbusco_extension})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-detroitbusco)

[ring-taylor]
exten => s,1,Macro(metric,ring-taylor)
same => n,Dial(SIP/${taylor_extension})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-taylor)

[ring-opensignal]
exten => s,1,Macro(metric,ring-opensignal)
same => n,Dial(SIP/${opensignal_extension})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-opensignal)

[ring-ypsi]
exten => s,1,Macro(metric,ring-ypsi)
same => n,Dial(SIP/${ypsi_extension})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-ypsi)

[ring-crossclinton]
exten => s,1,Macro(metric,ring-crossclinton)
same => n,Dial(SIP/${crossclinton_extension})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-crossclinton)

[ring-mykle]
exten => s,1,Macro(metric,ring-mykle)
same => n,Dial(SIP/${mykle_extension})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-mykle)

[ring-paz]
exten => s,1,Macro(metric,ring-paz)
same => n,Dial(SIP/${paz_extension})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-paz)

[ring-robotron]
exten => s,1,Macro(metric,ring-robotron)
same => n,Dial(SIP/${robotron_extension})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-robotron)

[ring-souwester]
exten => s,1,Macro(metric,ring-souwester)
same => n,Dial(SIP/${souwester_extension})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-souwester)

[ring-hoyt]
exten => s,1,Macro(metric,ring-hoyt)
same => n,Dial(SIP/${hoyt_extension})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-hoyt)

[incoming-ivr]
exten => s,1,Macro(metric,incoming-ivr)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)    
same => n,Answer(500)       ; is this necessary?
same => n,WaitExten(0.1)
same => n,Macro(say,para-espanol,outgoing)
same => n,Macro(say,oprima-estrella,outgoing)
same => n,Macro(say,welcome-to-fewtel,incoming)
same => n,Macro(say,for-voicemail,incoming)
same => n,Macro(say,press-one,incoming)
same => n,Macro(say,for-the-fewtel-community,incoming)
same => n,Macro(say,press-two,incoming)
same => n,Macro(say,to-speak-to-an-operator,incoming)
same => n,Macro(say,press-zero,incoming)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 1,1,Gosub(incoming-voicemail,s,1)
same => n,Goto(s,postsetup)
exten => 2,1,Gosub(community-incoming,s,1)
same => n,Goto(s,postsetup)
; secret member menu
exten => 7,1,Gosub(member-auth,s,1)
same => n,Goto(s,postsetup)
; secret admin menu
exten => 8,1,Gosub(admin-auth,s,1)
same => n,Goto(s,postsetup)
; secret fake admin menu
exten => 9,1,Gosub(incoming-fake-admin-auth,s,1)
same => n,Goto(s,postsetup)
exten => 0,1,VoiceMail(1337,u)
exten => *,1,Macro(languagees)
same => n,Goto(s,postsetup)
exten => i,1,Goto(s,postsetup)

[futel-information]
exten => s,1,Macro(metric,futel-information)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,WaitExten(0.1)
same => n,Macro(say,fewtel-is-portlands-most-exclusive-telephone-network,information)
same => n,Macro(say,fewtel-provides-telephony-and-voicemail-and-human-and-machine-interaction,information)
same => n,WaitExten(0.25)
same => n,Macro(say,all-services-are-free-from-any-fewtel-phone,information)
same => n,WaitExten(0.25)
same => n,Macro(say,for-more-information-contact-the-operator-from-any-fewtel-phone-or-visit-our-website-at-fewtel-dot-net,information)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => #,1,Return
exten => i,1,Goto(s,postsetup)

[admin-auth]
exten => s,1,Macro(metric,admin-auth)
same => n,AGI(incoming_ratelimit.agi)
same => n,Macro(setup-iteration)    
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,Authenticate(${admin_password})
same => n,Wait(0.25)    ;avoid digits leaking into next menu
same => n,Goto(admin_main,s,1)

[incoming-fake-admin-auth]
    exten => s,1,Macro(metric,incoming-fake-admin-auth)
    same => n,Macro(setup-iteration)    
    same => n(postsetup),NoOp
    same => n,Macro(iterate-guard)    
    same => n,Authenticate(592751)
    same => n,Wait(0.25)    ;avoid digits leaking into next menu
    same => n,Hangup

[member-auth]
exten => s,1,Macro(metric,member-auth)
same => n,AGI(incoming_ratelimit.agi)
same => n,Macro(setup-iteration)    
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,Authenticate(${member_password})
same => n,Wait(0.25)    ;avoid digits leaking into next menu
same => n,Goto(member_main,s,1)

; context to start outgoing call
; Softphone clients should generally go to outgoing-by-calling-extension, on 999.
[default-outgoing]
exten => 988,1,Set(destination=challenge_shadytel_main)
same => n,Goto(outgoing-by-destination,s,1)
exten => 989,1,Set(destination=challenge_main)
same => n,Goto(outgoing-by-destination,s,1)
exten => 993,1,Set(destination=member_main)
same => n,Goto(outgoing-by-destination,s,1)
exten => 994,1,Set(destination=outgoing_ypsi)
same => n,Goto(outgoing-by-destination,s,1)
exten => 995,1,Set(destination=outgoing_portland)
same => n,Goto(outgoing-by-destination,s,1)
exten => 996,1,Set(destination=restricted-outgoing-dialtone-wrapper)
same => n,Goto(outgoing-by-destination,s,1)
exten => 997,1,Set(destination=oracle-dead)
same => n,Goto(outgoing-by-destination,s,1)
exten => 998,1,Set(destination=admin_main)
same => n,Goto(outgoing-by-destination,s,1)
; 999 dialed by public phone SIP clients
exten => 999,1,Goto(outgoing-by-calling-extension,s,1)
; 1000 used by r2d2, obsolete?
exten => 1000,1,Set(destination=outgoing-dialtone-wrapper)
same => n,Goto(outgoing-by-destination,s,1)
; 1001 used by incoming line
exten => 1001,1,Set(destination=incoming-ivr)
same => n,Goto(outgoing-by-destination,s,1)

[outgoing-by-destination]
; go to a destination determined by a variable value
exten => s,1,Macro(metric,outgoing-by-destination)
same => n,Set(CALLERID(num)=${callerid})
same => n,Goto(${destination},s,1)

[outgoing-by-calling-extension]
exten => s,1,Macro(metric,outgoing-by-calling-extension)
same => n,Set(CALLERID(num)=${callerid})
same => n,Goto(${outgoing_context},s,1)

; allow 911 from outgoing menu
[911-9]
exten => s,1,Macro(metric,911-9)
same => n,WaitExten(5)
same => n,Busy
exten => 1,1,Gosub(911-91,s,1)
; busy on invalid
exten => i,1,Busy

; continue to allow 911 from outgoing menu
[911-91]
exten => s,1,Macro(metric,911-91)
same => n,WaitExten(5)
same => n,Busy
exten => 1,1,Gosub(911-911,s,1)
; busy on invalid
exten => i,1,Busy

[911-911]
exten => s,1,Macro(metric,911-911)
same => n(postsetup),NoOp
same => n,Macro(say,dialing-nine-one-one)
same => n,Macro(dial,911)
; on invalid repeat, this at least lets panicky users think about what
; they're doing
exten => i,1,Goto(s,postsetup)

[outgoing-chooser]
exten => s,1,Macro(metric,outgoing-chooser)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,WaitExten(0.1)
same => n,Macro(say,for)
same => n,Macro(say,the)
same => n,Macro(say,portland)
same => n,Macro(say,menu)
same => n,Macro(say,press-one)
same => n,Macro(say,for)
same => n,Macro(say,the)
same => n,Macro(say,ipsalanty)
same => n,Macro(say,menu)
same => n,Macro(say,press-two)
same => n,Macro(say,for)
same => n,Macro(say,the)
same => n,Macro(say,souwester)
same => n,Macro(say,menu)
same => n,Macro(say,press-three)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 1,1,Goto(outgoing_portland,s,1)
exten => 2,1,Goto(outgoing_ypsi,s,1)
exten => 3,1,Goto(outgoing_souwester,s,1)
exten => i,1,Goto(s,postsetup)
exten => #,1,Return

[outgoing-dialtone-wrapper]
exten => s,1,Macro(metric,outgoing-dialtone-wrapper)
same => n,DISA(no-password,outgoing-dialtone)

[outgoing-dialtone]
exten => _911,1,Macro(dial,${EXTEN})
exten => _211,1,Macro(dial,+18666986155)
; 911 test
exten => _933,1,Macro(dial,${EXTEN})
; voip.ms 911 test, which must be in this format for some reason
exten => _15555550911,1,Macro(dial,${EXTEN})
; information numbers blocked by provider go to operator
exten => _NXX5551212,1,Goto(operator,s,1)
exten => _1NXX5551212,1,Goto(operator,s,1)
; 11 digit prefixed with 1: NANPA e.164, normalize with + prefix
exten => _1XXXXXXXXXX,1,Macro(filterdial,+${EXTEN})
; 10 digit not prefixed with 1 or 0: NANPA, normalize to e.164 with +1 prefix
exten => _NXXXXXXXXX,1,Macro(filterdial,+1${EXTEN})
; 14 digit prefixed with 011 1: NANPA with international and country code,
; normalize to e.164 with + prefix and no international code
exten => _0111XXXXXXXXXX,1,Macro(filterdial,+${EXTEN:3})
; 15 digit prefixed with 011 52: Mexico (no cell?)
; with international and country code,
; normalize to e.164 with + prefix and no international code
exten => _01152XXXXXXXXXX,1,Macro(filterdial,+${EXTEN:3})
; 12 digit prefixed with 52: Mexico (no cell?) e.164, normalize with + prefix
exten => _52XXXXXXXXXX,1,Macro(filterdial,+${EXTEN})
exten => _0,1,Goto(operator,s,1)
;exten => _#,1,Goto(outgoing-ivr,s,1)
exten => i,1,Busy               ; on invalid annoy caller

[restricted-outgoing-dialtone-wrapper]
exten => s,1,Macro(metric,restricted-outgoing-dialtone-wrapper)
same => n,DISA(no-password,restricted-outgoing-dialtone)

[restricted-outgoing-dialtone]
exten => _911,1,Macro(dial,${EXTEN})
exten => _211,1,Macro(dial,+18666986155)
; 911 test
exten => _933,1,Macro(dial,${EXTEN})
; voip.ms 911 test, which must be in this format for some reason
exten => _15555550911,1,Macro(dial,${EXTEN})
; operator goes directly to operator voicemail
exten => _0,1,VoiceMail(1337,u)
exten => i,1,Busy               ; on invalid annoy caller

[internal-dialtone-wrapper]
exten => s,1,Macro(metric,internal-dialtone-wrapper)
same => n,DISA(no-password,internal-dialtone)
exten => i,1,Busy               ; on invalid annoy caller

[internal-dialtone]
; dialtone that lets us call selected 3-digit extensions
exten => _5XX,1,Dial(SIP/${EXTEN}@twilio-pv-termination)
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-${EXTEN})
exten => _6XX,1,Dial(SIP/${EXTEN})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-${EXTEN})
exten => _7XX,1,Dial(SIP/${EXTEN}@twilio-pv-termination)
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS}-${EXTEN})

; Start recording of all channels to unique filename.
[operator-pre]
exten => s,1,NoOp
same => n,AGI(get_filename.agi)
same => n,MixMonitor(${agi_out}.wav,b)
same => n,Return

[followme-operator]
; context to define extensions for op destinations and op actions
; outgoingcontext variable isn't surviving to here, so we are using a hardcoded
; provider. This is OK because we don't deplete on dialtone capacity.
exten => ${karl_cell},1,Dial(SIP/${karl_cell}@voipms,,U(operator-pre))
exten => ${elijah_cell},1,Dial(SIP/${elijah_cell}@voipms,,U(operator-pre))
exten => ${xnor_cell},1,Dial(SIP/${xnor_cell}@voipms,,U(operator-pre))
exten => ${brandon},1,Dial(SIP/${brandon}@voipms,,U(operator-pre))
exten => ${mathew},1,Dial(SIP/${mathew}@voipms,,U(operator-pre))
exten => ${alma_frankenstein},1,Dial(SIP/${alma_frankenstein}@voipms,,U(operator-pre))
exten => ${will_caruana},1,Dial(SIP/${will_caruana}@voipms,,U(operator-pre))
exten => ${michelle_kline},1,Dial(SIP/${michelle_kline}@voipms,,U(operator-pre))
exten => ${mykle_cell},1,Dial(SIP/${mykle_cell}@voipms,,U(operator-pre))
exten => ${emily_wilson},1,Dial(SIP/${emily_wilson}@voipms,,U(operator-pre))
exten => ${jesse_cell},1,Dial(SIP/${jesse_cell}@voipms,,U(operator-pre))
; ; allow ops to transfer callers
; exten => 995,1,Goto(outgoing-dialtone-wrapper,s,1)
; ; may need to transfer back to main...
; exten => 999,1,Goto(outgoing_portland,s,1)

[outgoing-voicemail]
exten => s,1,Macro(metric,outgoing-voicemail)
same => n,Macro(setup-iteration)    
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,WaitExten(0.1)
same => n,Macro(say,to-check-your-voicemail,voicemail)
same => n,Macro(say,press-one,voicemail)
same => n,Macro(say,to-create-a-new-voicemail-box,voicemail)
same => n,Macro(say,press-two,voicemail)
same => n,Macro(say,to-leave-a-voicemail,voicemail)
same => n,Macro(say,press-three,voicemail)
same => n,Macro(say,for-more-information-about-the-fewtel-voicemail-system,voicemail)
same => n,Macro(say,press-four,voicemail)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
; check voicemail
exten => 1,1,Macro(metric,voicemail-main)
exten => 1,2,VoiceMailMain()
; create vm
exten => 2,1,Macro(metric,next-vm)
same => n,Macro(say,voicemail-can-be-accessed-from-any-fewtel-phone-or-from-the-fewtel-incoming-line,voicemail)
same => n,AGI(next_vm.agi)
same => n,system(/opt/asterisk/sbin/asterisk -x "voicemail reload")
same => n,VoiceMailMain(${vmbox})
; leave voicemail
exten => 3,1,Macro(metric,voicemail)
exten => 3,2,VoiceMail()
; more information about voicemail
exten => 4,1,Gosub(voicemail-information,s,1)
same => n,Goto(s,postsetup)
exten => #,1,Return    
exten => i,1,Goto(s,postsetup)

[incoming-voicemail]
exten => s,1,Macro(metric,incoming-voicemail)
same => n,AGI(incoming_ratelimit.agi)
same => n,Macro(setup-iteration)    
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)    
same => n,WaitExten(0.1)
same => n,Macro(say,to-check-your-voicemail,voicemail)
same => n,Macro(say,press-one,voicemail)
same => n,Macro(say,to-leave-a-voicemail,voicemail)
same => n,Macro(say,press-two,voicemail)
same => n,Macro(say,for-more-information-about-the-fewtel-voicemail-system,voicemail)
same => n,Macro(say,press-three,voicemail)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
; check voicemail
exten => 1,1,Macro(metric,voicemail-main)
exten => 1,2,VoiceMailMain()
; leave voicemail
exten => 2,1,Macro(metric,voicemail)
exten => 2,2,VoiceMail()
; more information about voicemail
exten => 3,1,Gosub(voicemail-information,s,1)
same => n,Goto(s,postsetup)
exten => #,1,Return    
exten => i,1,Goto(s,postsetup)

[voicemail-information]
exten => s,1,Macro(metric,voicemail-information)
same => n,Macro(setup-iteration)    
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)    
same => n,WaitExten(0.1)
same => n,Macro(say,voicemail-boxes-in-the-fewtel-voicemail-system-can-be-created-from-any-fewtel-phone,voicemail)
same => n,Macro(say,voicemail-boxes-in-the-fewtel-voicemail-system-can-be-accessed-from-any-fewtel-phone-or-from-the-fewtel-incoming-line,voicemail)
same => n,Macro(say,at,voicemail)
same => n,Macro(say,five,voicemail)
same => n,Macro(say,zero,voicemail)
same => n,Macro(say,three,voicemail)
same => n,Macro(say,four,voicemail)
same => n,Macro(say,six,voicemail)
same => n,Macro(say,eight,voicemail)
same => n,Macro(say,one,voicemail)
same => n,Macro(say,three,voicemail)
same => n,Macro(say,three,voicemail)
same => n,Macro(say,seven,voicemail)
same => n,Macro(say,again,voicemail)
same => n,Macro(say,at,voicemail)
same => n,Macro(say,five,voicemail)
same => n,Macro(say,zero,voicemail)
same => n,Macro(say,three,voicemail)
same => n,Macro(say,four,voicemail)
same => n,Macro(say,six,voicemail)
same => n,Macro(say,eight,voicemail)
same => n,Macro(say,one,voicemail)
same => n,Macro(say,three,voicemail)
same => n,Macro(say,three,voicemail)
same => n,Macro(say,seven,voicemail)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => #,1,Return    
exten => i,1,Goto(s,postsetup)

[network-ivr]
exten => s,1,Macro(metric,network-ivr)
same => n,Macro(setup-iteration)    
same => n,AGI(random_file_strip.agi,/opt/asterisk/var/lib/asterisk/sounds/futel/oracle-dead-interstitial-short)
same => n,Background(${agi_out})
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,WaitExten(0.1)
same => n,Macro(say,for-longmont-potion-castle,network)
same => n,Macro(say,press-one,network)
same => n,Macro(say,for-the-dark-fiber,network)
same => n,Macro(say,press-two,network)
same => n,Macro(say,for-the-p-l-a-telephone-network-interface,network)
same => n,Macro(say,press-three,network)
same => n,Macro(say,for-the-pink-phone-from-the-future,network)
same => n,Macro(say,press-four,network)
same => n,Macro(say,for-the-collectors-net-inbound-portal,network)
same => n,Macro(say,press-five,network)
same => n,Macro(say,for-the-mojave-phone-booth-conference-line,network)
same => n,Macro(say,press-six,network)
same => n,Macro(say,for-the-payphone-radio-network,network)
same => n,Macro(say,press-seven,network)
same => n,Macro(say,for-the-shadytel-voice-bbs,network)
same => n,Macro(say,press-eight,network)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 1,1,Gosub(longmont,s,1)
same => n,Goto(s,postsetup)
exten => 2,1,Goto(dark-fiber,s,1)
exten => 3,1,Goto(pla-interface,s,1)
exten => 4,1,Goto(pink-phone,s,1)
exten => 5,1,Goto(cnet-portal,s,1)
exten => 6,1,Goto(mojave-conference,s,1)
exten => 7,1,Goto(payphone-radio,s,1)
exten => 8,1,Goto(shady-bbs,s,1)
exten => i,1,Goto(s,postsetup)
exten => #,1,Return

[community-services-oregon]
exten => s,1,Macro(metric,community-services-oregon)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,WaitExten(0.1)
same => n,Macro(say,for-two-one-one-community-resources,community-service)
same => n,Macro(say,press-one,community-service)
same => n,Macro(say,for-multnomah-county-mental-health-crisis-intervention,community-service)
same => n,Macro(say,press-two,community-service)
same => n,Macro(say,for-the-call-to-safety-crisis-line,community-service)
same => n,Macro(say,press-three,community-service)
same => n,Macro(say,for-the-suicide-prevention-hotline,community-service)
same => n,Macro(say,press-four,community-service)
same => n,Macro(say,for-an-obamaphone,community-service)
same => n,Macro(say,press-five,community-service)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 1,1,Goto(info-211,s,1)
exten => 2,1,Goto(mental-health-crisis,s,1)
exten => 3,1,Goto(call-to-safety,s,1)
exten => 4,1,Goto(suicide-hotline,s,1)
exten => 5,1,Goto(obamaphone-oregon,s,1)
exten => i,1,Goto(s,postsetup)
exten => #,1,Return

[community-services-michigan]
exten => s,1,Macro(metric,community-services-michigan)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,WaitExten(0.1)
same => n,Macro(say,for-the-suicide-prevention-hotline,community-service)
same => n,Macro(say,press-four,community-service)
same => n,Macro(say,for-an-obamaphone,community-service)
same => n,Macro(say,press-five,community-service)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 4,1,Goto(suicide-hotline,s,1)
exten => 5,1,Goto(obamaphone-michigan,s,1)
exten => i,1,Goto(s,postsetup)
exten => #,1,Return

[community-outgoing]
exten => s,1,Macro(metric,community-outgoing)
same => n,Macro(setup-iteration)    
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,WaitExten(0.1)
same => n,Macro(say,for-the-fewtel-voice-conference,community)
same => n,Macro(say,press-one,community)
same => n,Macro(say,for-the-wildcard-line,community)
same => n,Macro(say,press-two,community)
same => n,Macro(say,for-the-church-of-robotron,community)
same => n,Macro(say,press-three,community)
same => n,Macro(say,to-ring-a-fewtel-telephone,community)
same => n,Macro(say,press-four,community)
same => n,Macro(say,for-hold-the-phone,community)
same => n,Macro(say,press-five,community)
same => n,Macro(say,for-the-apology-service,community)
same => n,Macro(say,press-six,community)
same => n,Macro(say,for-more-information-about-fewtel,community)
same => n,Macro(say,press-seven,community)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 1,1,Goto(futel-conf,s,1)
exten => 2,1,Gosub(wildcard_line_outgoing,s,1)
same => n,Goto(s,postsetup)
exten => 3,1,Gosub(robotron,s,1)
same => n,Goto(s,postsetup)
exten => 4,1,Goto(internal-dialtone-wrapper,s,1)
exten => 5,1,Goto(hold_the_phone_main,s,1)
exten => 6,1,Gosub(apology-service-ivr,s,1)
same => n,Goto(s,postsetup)
exten => 7,1,Gosub(futel-information,s,1)
same => n,Goto(s,postsetup)
exten => i,1,Goto(s,postsetup)
exten => #,1,Return

[community-incoming]
exten => s,1,Macro(metric,community-incoming)
same => n,Macro(setup-iteration)    
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,WaitExten(0.1)
same => n,Macro(say,for-the-fewtel-voice-conference,community)
same => n,Macro(say,press-one,community)
same => n,Macro(say,for-the-wildcard-line,community)
same => n,Macro(say,press-two,community)
same => n,Macro(say,for-the-church-of-robotron,community)
same => n,Macro(say,press-three,community)
same => n,Macro(say,to-ring-a-fewtel-telephone,community)
same => n,Macro(say,press-four,community)
same => n,Macro(say,for-hold-the-phone,community)
same => n,Macro(say,press-five,community)
same => n,Macro(say,for-the-apology-service,community)
same => n,Macro(say,press-six,community)
same => n,Macro(say,for-more-information-about-fewtel,community)
same => n,Macro(say,press-seven,community)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 1,1,Goto(futel-conf,s,1)
exten => 2,1,Gosub(wildcard_line_incoming,s,1)
same => n,Goto(s,postsetup)
exten => 3,1,Gosub(robotron,s,1)
same => n,Goto(s,postsetup)
exten => 4,1,Goto(internal-dialtone-wrapper,s,1)
exten => 5,1,Goto(hold_the_phone_main,s,1)
exten => 6,1,Gosub(apology-service-ivr,s,1)
same => n,Goto(s,postsetup)
exten => 7,1,Gosub(futel-information,s,1)
same => n,Goto(s,postsetup)
exten => i,1,Goto(s,postsetup)
exten => #,1,Return

[utilities-ivr]
exten => s,1,Macro(metric,utilities-ivr)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,WaitExten(0.1)
same => n,Macro(say,for-the-current-time,utilities)
same => n,Macro(say,press-one,utilities)
same => n,Macro(say,for-the-trymet-transit-tracker,utilities)
same => n,Macro(say,press-two,utilities)
same => n,Macro(say,to-access-your-multnomah-county-library-account,utilities)
same => n,Macro(say,press-three,utilities)
same => n,Macro(say,for-a-random-number,utilities)
same => n,Macro(say,press-five,utilities)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 1,1,Goto(current-time,s,1)
exten => 2,1,Goto(trimet-transit-tracker,s,1)
exten => 3,1,Goto(lib-account-line,s,1)
exten => 5,1,Goto(random-number,s,1)
exten => i,1,Goto(s,postsetup)
exten => #,1,Return

[utilities-ivr-ypsi]
exten => s,1,Macro(metric,utilities-ivr-ypsi)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,WaitExten(0.1)
same => n,Macro(say,for-the-current-time,utilities)
same => n,Macro(say,press-one,utilities)
same => n,Macro(say,for-a-random-number,utilities)
same => n,Macro(say,press-five,utilities)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 1,1,Goto(current-time-ypsi,s,1)
exten => 5,1,Goto(random-number,s,1)
exten => i,1,Goto(s,postsetup)
exten => #,1,Return

[utilities-ivr-souwester]
exten => s,1,Macro(metric,utilities-ivr-souwester)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,WaitExten(0.1)
same => n,Macro(say,for-the-current-time,utilities)
same => n,Macro(say,press-one,utilities)
same => n,Macro(say,for-a-random-number,utilities)
same => n,Macro(say,press-two,utilities)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 1,1,Goto(current-time,s,1)
exten => 2,1,Goto(random-number,s,1)
exten => i,1,Goto(s,postsetup)
exten => #,1,Return

[apology-service-ivr]
exten => s,1,Macro(metric,apology-service-ivr)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,WaitExten(0.1)
same => n,Macro(say,to-apologize,apology-service)
same => n,Macro(say,press-one,apology-service)
same => n,Macro(say,to-learn-more-about-the-apology-service,apology-service)
same => n,Macro(say,press-two,apology-service)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 1,1,Goto(apology-service,s,1)
same => n,Goto(s,postsetup)
exten => 2,1,Gosub(about-apology,s,1)
exten => #,1,Return
exten => i,1,Goto(s,postsetup)

[about-apology]
exten => s,1,Macro(metric,about-apology)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,WaitExten(0.1)
same => n,Macro(say,apologies-are-not-recorded-or-listened-to,apology-service)
same => n,WaitExten(0.25)
same => n,Macro(say,this-apology-service-is-an-homage-to-allen-bridges-apology-line,apology-service)
same => n,Macro(say,we-hope-you-find-the-act-of-apologizing-helpful,apology-service)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => #,1,Return
exten => i,1,Goto(s,postsetup)

[apology-service]
exten => s,1,Macro(metric,apology-service)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,macro(say,begin-to-apologize-after-the-tone,apology-service)
same => n,Playtones(record)
same => n,Wait(600)
same => n,Busy()

; directory
[mayor-vm]
exten => s,1,Macro(metric,mayor-vm)
same => n,Macro(dial,+15038234120)

[mayor-vm-ypsi]
exten => s,1,Macro(metric,mayor-vm-ypsi)
same => n,Macro(dial,+17344831100)

[mayor-vm-detroit]
exten => s,1,Macro(metric,mayor-vm-detroit)
same => n,Macro(dial,+13132243400)

[record]
    exten => s,1,Macro(metric,record)
    same => n,AGI(record_statements.agi)

[trimet-transit-tracker]
    exten => s,1,Macro(metric,trimet-transit-tracker)
    same => n,Macro(dial,+15032387433)

[lib-account-line]
    exten => s,1,Macro(metric,lib-account-line)
    same => n,Macro(dial,+15039885342)

[cnet-portal]
    exten => s,1,Macro(metric,cnet-portal)
    same => n,Macro(dial,+19149401363)

; call "payphone shotgun" using queue
[random-payphone]
exten => s,1,Macro(metric,random-payphone)
same => n,Queue(payphones,r)

; call random concentration camp using queue
[random-concentrationcamp]
exten => s,1,Macro(metric,random-concentrationcamp)
same => n,Queue(concentrationcamps,r)

; get random destination from script and call it
[dark-fiber]
exten => s,1,Macro(metric,dark-fiber)
same => n,AGI(dark_fiber.agi)
same => n,Macro(dial,${agi_out})

[pla-interface]
exten => s,1,Macro(metric,pla-interface)
same => n,Macro(dial,+15056086123)

[pink-phone]
exten => s,1,Macro(metric,pink-phone)
same => n,Macro(dial,+17737992961)

[lance-e-pants]
    exten => s,1,Macro(metric,lance-e-pants)
    same => n,Macro(dial,${e_pants})

[current-time]
    exten => s,1,Macro(metric,current-time)
    same => n,SayUnixTime()

[current-time-ypsi]
    exten => s,1,Macro(metric,current-time-ypsi)
    same => n,SayUnixTime(,EST5EDT)

[info-211]
    exten => s,1,Macro(metric,info-211)
    same => n,Macro(dial,+18666986155)

[dream-survey]
    exten => s,1,Macro(metric,dream-survey)
    same => n,Macro(dial,+19712581465)

[office-of-night-things]
    exten => s,1,Macro(metric,office-of-night-things)
    same => n,Macro(dial,+18003900934)

[beyond-the-echo]
    exten => s,1,Macro(metric,beyond-the-echo)
    same => n,Macro(dial,+12703015797)

[random-number]
; read back a random number to the caller
exten => s,1,Macro(metric,random-number)
same => n(random-number),NoOp
same => n,set(current=${RAND(0,99)})
same => n,Macro(say,your-random-number-is,utilities)
same => n(current-number),NoOp
same => n,SayNumber(${current})
same => n(postsetup),NoOp
same => n,Macro(say,to-hear-number-again,utilities)
same => n,Macro(say,press-one,utilities)
same => n,Macro(say,for-a-random-number,utilities)
same => n,Macro(say,press-two,utilities)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 1,1,Goto(s,current-number)
exten => 2,1,Goto(s,random-number)
exten => #,1,Return
exten => i,1,Goto(s,postsetup)

[futel-conf]
    ; incoming ConfBridge
    exten => s,1,Macro(metric,futel-conf)
    same => n,ConfBridge(666,futel_conf,futel_conf_user,futel_conf_menu)

[mojave-conference]
exten => s,1,Macro(metric,mojave-conference)
same => n,Macro(dial,+17607339969)

[mental-health-crisis]
exten => s,1,Macro(metric,mental-health-crisis)
same => n,Macro(dial,+15039884888)

[call-to-safety]
; https://calltosafety.org/
exten => s,1,Macro(metric,call-to-safety)
same => n,Macro(dial,+15032355333)

[suicide-hotline]
; national suicide prevention lifeline https://suicidepreventionlifeline.org/
exten => s,1,Macro(metric,suicide-hotline)
same => n,Macro(dial,+18002738255)

[obamaphone-oregon]
; assurance wireless
exten => s,1,Macro(metric,obamaphone-oregon)
same => n,Macro(dial,+18883215880)

[obamaphone-michigan]
; at&t mobility 
exten => s,1,Macro(metric,obamaphone-michigan)
same => n,Macro(dial,+18003779450)

[operator]
exten => s,1,Macro(metric,operator)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,UserEvent(OperatorAttempt)
same => n,Macro(say,please-hold)
same => n,Macro(say,for-the-next-available-operator)
same => n,FollowMe(operator,d)
; if we got here, no operator accepted
same => n,Macro(metric,operator-nopickup)
same => n,UserEvent(OperatorNoPickup)
same => n,VoiceMail(1337,u)
; on invalid repeat, this at least lets panicky users think about what
; they're doing during the intro statements
exten => i,1,Goto(s,postsetup)

; submenu to call out from a conference
; XXX this is an unfiltered DID
; [add-futel-conf]
;     exten => s,1,Macro(metric,add-futel-conf)
;     ; read a phone number from user and store it in ${did}
;     same => n,Read(did,,11)
;     ; TODO use ${outgoing_channel} for the sip trunk
;     same => n,Originate(SIP/callcentric-tishbite/${did},exten,futel-conf)

[longmont]
exten => s,1,Macro(metric,longmont)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,AGI(random_file_strip.agi,/opt/asterisk/var/lib/asterisk/sounds/futel/longmont)
same => n,Background(${agi_out})
same => n,Return
exten => i,1,Return

[payphone-radio]
exten => s,1,Macro(metric,payphone-radio)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,MP3Player(http://104.167.4.67:8136/stream)
same => n,Return
exten => i,1,Return

[shady-bbs]
exten => s,1,Macro(metric,shady-bbs)
same => n,Macro(dial,+18134695930)

#include extensions_secret.conf
#include extensions_holdthephone.conf
#include extensions_oracle.conf
#include extensions_robotron.conf
